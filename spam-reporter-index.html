<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Zgłoś Spam | Ratels Security</title>
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>
  <link href="styles.css" rel="stylesheet">
  <style>
    .report-card { background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #0002; max-width: 700px; margin: 32px auto; padding: 32px 28px; font-family: 'Segoe UI', Arial, sans-serif; }
    .report-header { font-size: 2em; font-weight: bold; color: #1976d2; margin-bottom: 18px; display: flex; align-items: center; gap: 12px; }
    .report-header .icon { font-size: 1.2em; }
    .meta-table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
    .meta-table td { padding: 8px 6px; border-bottom: 1px solid #e3eaf2; }
    .meta-table .label { font-weight: bold; color: #1976d2; width: 160px; }
    .section-title { font-weight: bold; color: #1976d2; margin: 18px 0 8px 0; font-size: 1.1em; }
    .attachments-list, .links-list { list-style: none; padding-left: 0; margin: 0; }
    .attachments-list li, .links-list li { margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .attachment-icon { color: #888; font-size: 1.1em; }
    .link-icon { color: #1976d2; font-size: 1.1em; }
    .empty { color: #aaa; font-style: italic; }
    .body-section { background: #f1f8fe; border-radius: 6px; padding: 14px 16px; border: 1px solid #e3eaf2; margin-bottom: 12px; }
    .body-label { color: #1976d2; font-weight: bold; margin-bottom: 4px; display: block; }
    .footer { margin-top: 24px; color: #aaa; font-size: 0.95em; text-align: center; }
    .header-row { display: flex; gap: 12px; align-items: center; }
    .priority-high { color: #d32f2f; font-weight: bold; }
    .priority-normal { color: #1976d2; }
    .meta-table .value { color: #222; }
  </style>
</head>
<body>
  <div class="lang-switcher">
    <a href="spam-reporter-index.html" aria-label="Polski"><img alt="PL" src="https://flagcdn.com/pl.svg" style="margin-right: 6px; vertical-align: middle;" width="24"/></a>
    <a href="spam-reporter-indexENG.html" aria-label="English"><img alt="EN" src="https://flagcdn.com/gb.svg" style="vertical-align: middle;" width="24"/></a>
  </div>

  <div class="container">
    <div class="logo-container">
      <a href="https://ratels.pl" target="_blank" aria-label="Strona główna Ratels">
        <img alt="Logo Ratels" src="https://ratels.pl/wp-content/themes/ratels/img/logo-przezrozczyste.svg"/>
      </a>
    </div>
    <div class="report-card">
      <div class="report-header"><span class="icon">🚨</span>Zgłoszenie podejrzanej wiadomości</div>
      <table class="meta-table">
        <tr><td class="label">Temat:</td><td class="value" id="meta-subject"></td></tr>
        <tr><td class="label">Nadawca:</td><td class="value" id="meta-sender"></td></tr>
        <tr><td class="label">Odbiorcy:</td><td class="value" id="meta-to"></td></tr>
        <tr><td class="label">DW (CC):</td><td class="value" id="meta-cc"></td></tr>
        <tr><td class="label">UDW (BCC):</td><td class="value" id="meta-bcc"></td></tr>
        <tr><td class="label">Data otrzymania:</td><td class="value" id="meta-date"></td></tr>
        <tr><td class="label">ID wiadomości:</td><td class="value" id="meta-id"></td></tr>
        <tr><td class="label">Priorytet:</td><td class="value" id="meta-priority"></td></tr>
        <tr><td class="label">Rozmiar:</td><td class="value" id="meta-size"></td></tr>
      </table>
      <div class="section-title">Załączniki:</div>
      <ul class="attachments-list" id="attachments-list"></ul>
      <div class="section-title">Linki znalezione w wiadomości:</div>
      <ul class="links-list" id="links-list"></ul>
      <div class="section-title">Fragment nagłówków:</div>
      <div class="body-section" id="headers-fragment"></div>
      <div class="section-title">Treść wiadomości:</div>
      <div class="body-section"><span class="body-label">--- Treść wiadomości ---</span><div id="body-preview"></div><span class="body-label">--- Koniec treści ---</span></div>
      <div class="footer">Wiadomość wygenerowana automatycznie przez system zgłoszeń Ratels Security</div>
    </div>
  </div>

  <script>
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(tag) {
        const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return charsToReplace[tag] || tag;
      });
    }

    function formatBytes(bytes) {
      if (!bytes || isNaN(bytes)) return '-';
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      if (bytes === 0) return '0 B';
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    function getPriority(priority) {
      if (!priority) return '<span class="priority-normal">Normalny</span>';
      if (priority === 'high' || priority === 'High' || priority === '1') return '<span class="priority-high">Wysoki</span>';
      return '<span class="priority-normal">Normalny</span>';
    }

    Office.onReady(() => {
      const item = Office.context.mailbox.item;
      document.getElementById('meta-subject').innerText = item.subject || '(brak tematu)';
      document.getElementById('meta-sender').innerText = item.from ? (item.from.emailAddress || item.from.displayName) : '(nieznany nadawca)';
      document.getElementById('meta-to').innerText = item.to && item.to.length ? item.to.map(x => x.emailAddress || x.displayName).join(', ') : '-';
      document.getElementById('meta-cc').innerText = item.cc && item.cc.length ? item.cc.map(x => x.emailAddress || x.displayName).join(', ') : '-';
      document.getElementById('meta-bcc').innerText = item.bcc && item.bcc.length ? item.bcc.map(x => x.emailAddress || x.displayName).join(', ') : '-';
      document.getElementById('meta-date').innerText = item.dateTimeCreated ? new Date(item.dateTimeCreated).toLocaleString() : '(nieznany czas)';
      document.getElementById('meta-id').innerText = item.internetMessageId || '-';
      document.getElementById('meta-priority').innerHTML = getPriority(item.importance);
      document.getElementById('meta-size').innerText = formatBytes(item.size);

      // Załączniki
      const attList = document.getElementById('attachments-list');
      if (item.attachments && item.attachments.length) {
        attList.innerHTML = item.attachments.map(att => `<li><span class="attachment-icon">📎</span>${escapeHTML(att.name || att.fileName || '(bez nazwy)')} <span style='color:#888;font-size:0.95em;'>(${formatBytes(att.size)}, ${escapeHTML(att.contentType || '-')})</span></li>`).join('');
      } else {
        attList.innerHTML = '<li class="empty">Brak załączników</li>';
      }

      // Linki
      const linksList = document.getElementById('links-list');
      function extractLinks(text) {
        if (!text) return [];
        const urlRegex = /https?:\/\/[\w\-\.\/?#&=;%+~:@!$'()*\[\],]+/gi;
        return text.match(urlRegex) || [];
      }
      item.body.getAsync(Office.CoercionType.Text, function(result) {
        let cleaned = '(brak treści)';
        if (result.status === Office.AsyncResultStatus.Succeeded && result.value) {
          cleaned = result.value;
        }
        const links = extractLinks(cleaned);
        if (links.length) {
          linksList.innerHTML = links.map(link => `<li><span class="link-icon">🔗</span><a href="${link}" target="_blank">${escapeHTML(link)}</a></li>`).join('');
        } else {
          linksList.innerHTML = '<li class="empty">Brak linków</li>';
        }
        // Treść wiadomości (fragment)
        document.getElementById('body-preview').innerText = cleaned.length > 1200 ? cleaned.substring(0, 1200) + '...' : cleaned;
      });

      // Fragment nagłówków (jeśli możliwe)
      if (item.internetMessageHeaders && item.internetMessageHeaders.length) {
        const headersFrag = item.internetMessageHeaders.slice(0, 8).map(h => `<div><b>${escapeHTML(h.name)}:</b> <span style='color:#555'>${escapeHTML(h.value)}</span></div>`).join('');
        document.getElementById('headers-fragment').innerHTML = headersFrag;
      } else {
        document.getElementById('headers-fragment').innerHTML = '<span class="empty">Brak nagłówków</span>';
      }
    });
  </script>
</body>
</html>
