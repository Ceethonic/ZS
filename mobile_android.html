<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Zgłoś Spam | Ratels Security</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
    h1 { font-size: 1.5em; }
    .message { margin: 16px 0; padding: 12px; border-radius: 4px; }
    .success { background: #e6ffe6; color: #1a7f1a; }
    .error { background: #ffe6e6; color: #a11a1a; }
    button { margin-top: 12px; padding: 8px 16px; font-size: 1em; border-radius: 4px; border: none; background: #0078d4; color: #fff; cursor: pointer; }
    button:active { background: #005fa3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Zgłoś spam</h1>
    <p>Kliknij przycisk, aby zgłosić podejrzaną wiadomość do zespołu bezpieczeństwa.</p>
    <button id="reportBtn">Zgłoś jako spam</button>
    <div id="resultMessage" class="message" style="display:none"></div>
  </div>
  <script>
    function showMessage(text, type = 'success') {
      const div = document.getElementById("resultMessage");
      div.textContent = text;
      div.className = 'message ' + type;
      div.style.display = "block";
    }

    Office.onReady(() => {
      document.getElementById("reportBtn").addEventListener("click", () => {
        const loadingMsg = "Wysyłanie zgłoszenia...";
        showMessage(loadingMsg, "success");
        document.getElementById("reportBtn").disabled = true;

        const item = Office.context.mailbox.item;
        if (!item) {
          showMessage("Nie można pobrać szczegółów wiadomości.", "error");
          document.getElementById("reportBtn").disabled = false;
          return;
        }

        // Pobierz podstawowe dane
        const data = {
          subject: item.subject || "(brak tematu)",
          sender: item.from ? (item.from.emailAddress || item.from.displayName) : "(nieznany nadawca)",
          receivedTime: item.dateTimeCreated ? new Date(item.dateTimeCreated).toLocaleString() : "(nieznany czas)",
          messageId: item.internetMessageId || "(brak ID)"
        };

        // Pobierz treść (asynchronicznie)
        item.body.getAsync(Office.CoercionType.Text, function(result) {
          let cleaned = "(brak treści)";
          if (result.status === Office.AsyncResultStatus.Succeeded && result.value) {
            cleaned = result.value;
          }

          // Wyślij dane do backendu
          fetch('https://TWOJ_BACKEND/report-spam', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              ...data,
              body: cleaned
            })
          })
          .then(res => res.json())
          .then(result => {
            showMessage(result.success ? "Zgłoszono!" : "Błąd: " + result.error, result.success ? "success" : "error");
            document.getElementById("reportBtn").disabled = false;
          })
          .catch(err => {
            showMessage("Błąd połączenia: " + err.message, "error");
            document.getElementById("reportBtn").disabled = false;
          });
        });
      });
    });
  </script>
</body>
</html>
