<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Zgłoś Spam - Funkcje</title>
    
    <!-- Office JS API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    
    <script type="text/javascript">
        // Inicjalizacja Office JS
        Office.onReady(function(info) {
            // Sprawdź parametry URL
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'reportSpam') {
                // Jeśli przyszliśmy z indeksu, wywołaj funkcję sprawdzającą
                checkIfAlreadyReported();
            }
        });
        
        // Funkcja sprawdzająca czy wiadomość została już zgłoszona
        function checkIfAlreadyReported() {
            try {
                var messageId = Office.context.mailbox.item.internetMessageId;
                var userEmail = Office.context.mailbox.userProfile.emailAddress;
                
                // Klucz do localStorage będzie kombinacją ID wiadomości i adresu email użytkownika
                var storageKey = "spam_reported_" + messageId + "_" + userEmail;
                
                // Sprawdzamy czy wiadomość została już zgłoszona
                var alreadyReported = localStorage.getItem(storageKey);
                
                if (alreadyReported) {
                    showNotification("Ta wiadomość została już wcześniej zgłoszona jako spam.");
                    document.getElementById("alreadyReported").style.display = "block";
                } else {
                    // Jeśli nie została zgłoszona, raportujemy i zapisujemy informację
                    reportSpam();
                    localStorage.setItem(storageKey, new Date().toISOString());
                }
            } catch (error) {
                // Jeśli wystąpi błąd przy sprawdzaniu, kontynuujemy zgłaszanie
                reportSpam();
            }
        }
        
        // Główna funkcja zgłaszania spamu
        function reportSpam() {
            try {
                // Przygotowanie treści zgłoszenia
                var subject = "SPAM ALERT: " + Office.context.mailbox.item.subject;
                var body = "Użytkownik " + Office.context.mailbox.userProfile.emailAddress + 
                          " oznaczył tę wiadomość jako spam. Prosimy o zablokowanie nadawcy w systemie bezpieczeństwa poczty.";
                
                // Załącznik to oryginalna wiadomość
                var attachments = [{
                    type: "item",
                    itemId: Office.context.mailbox.item.itemId,
                    name: "original_spam_message.eml"
                }];
                
                // Przesłanie wiadomości do działu bezpieczeństwa automatycznie
                // Tworzenie obiektu wiadomości e-mail
                var emailDetails = {
                    toRecipients: ["tomaszciszewski01@gmail.com"],
                    subject: subject,
                    htmlBody: body,
                    attachments: attachments
                };
                
                // Próba wysłania wiadomości automatycznie przez EWS
                try {
                    Office.context.mailbox.makeEwsRequestAsync(
                        getEwsSendMessageXml(emailDetails),
                        function(asyncResult) {
                            if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                                // Pomyślnie wysłano wiadomość
                                showNotification("Wiadomość została zgłoszona jako spam");
                                document.getElementById("confirmation").style.display = "block";
                                
                                // Przenieś wiadomość do kosza
                                moveToTrash();
                            } else {
                                // Wystąpił błąd, spróbuj alternatywnej metody wysyłania
                                fallbackSendMethod(emailDetails);
                            }
                        }
                    );
                } catch (error) {
                    // Błąd przy wysyłaniu, użyj alternatywnej metody
                    fallbackSendMethod({
                        toRecipients: ["tomaszciszewski01@gmail.com"],
                        subject: subject,
                        htmlBody: body,
                        attachments: attachments
                    });
                }
            } catch (error) {
                console.error("Błąd zgłaszania spamu:", error);
                document.getElementById("error").textContent = "Wystąpił błąd: " + error.message;
                document.getElementById("error").style.display = "block";
            }
        }
        
        // Funkcja przesuwająca wiadomość do kosza
        function moveToTrash() {
            try {
                // Próbujemy różnych metod przeniesienia do kosza
                tryMoveToTrashMethods();
            } catch (error) {
                document.getElementById("error").textContent = "Nie udało się przenieść wiadomości do kosza: " + error.message;
                document.getElementById("error").style.display = "block";
                
                // Mimo błędu, pokazujemy częściowe potwierdzenie
                document.getElementById("partialConfirmation").style.display = "block";
            }
        }
        
        // Funkcja próbująca różnych metod przeniesienia do kosza
        function tryMoveToTrashMethods() {
            var moved = false;
            
            // Metoda 1: move (dla nowszych wersji Outlook)
            try {
                if (Office.context.mailbox.item.move && typeof Office.context.mailbox.item.move === 'function') {
                    Office.context.mailbox.item.move("Deleted Items", function(result) {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            document.getElementById("confirmation").style.display = "block";
                            moved = true;
                        } else {
                            tryNextMoveMethod(moved);
                        }
                    });
                    return; // Wyjdź i czekaj na callback
                }
            } catch (error) {
                console.log("Błąd metody move:", error.message);
            }
            
            tryNextMoveMethod(moved);
        }
        
        // Kontynuuj próby z kolejnymi metodami
        function tryNextMoveMethod(moved) {
            if (moved) return;
            
            // Metoda 2: moveToFolderAsync (dla niektórych wersji)
            try {
                if (typeof Office.context.mailbox.item.moveToFolderAsync === 'function') {
                    Office.context.mailbox.item.moveToFolderAsync("deleteditems", function(result) {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            document.getElementById("confirmation").style.display = "block";
                            moved = true;
                        } else {
                            tryEwsMethod(moved);
                        }
                    });
                    return; // Wyjdź i czekaj na callback
                }
            } catch (error) {
                console.log("Błąd metody moveToFolderAsync:", error.message);
            }
            
            tryEwsMethod(moved);
        }
        
        // Próba użycia EWS API
        function tryEwsMethod(moved) {
            if (moved) return;
            
            // Metoda 3: EWS API (dla starszych wersji)
            try {
                if (Office.context.mailbox.makeEwsRequestAsync) {
                    var itemId = Office.context.mailbox.item.itemId;
                    if (itemId) {
                        var ewsRequest = 
                            '<?xml version="1.0" encoding="utf-8"?>' +
                            '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
                            'xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages" ' +
                            'xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types" ' +
                            'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
                            '  <soap:Header>' +
                            '    <t:RequestServerVersion Version="Exchange2013" />' +
                            '  </soap:Header>' +
                            '  <soap:Body>' +
                            '    <m:MoveItem>' +
                            '      <m:ToFolderId>' +
                            '        <t:DistinguishedFolderId Id="deleteditems"/>' +
                            '      </m:ToFolderId>' +
                            '      <m:ItemIds>' +
                            '        <t:ItemId Id="' + itemId + '"/>' +
                            '      </m:ItemIds>' +
                            '    </m:MoveItem>' +
                            '  </soap:Body>' +
                            '</soap:Envelope>';
                        
                        Office.context.mailbox.makeEwsRequestAsync(ewsRequest, function(result) {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                document.getElementById("confirmation").style.display = "block";
                                moved = true;
                            } else {
                                // Jeśli wszystkie metody zawiodły, pokazujemy częściowe potwierdzenie
                                document.getElementById("partialConfirmation").style.display = "block";
                            }
                        });
                        return; // Wyjdź i czekaj na callback
                    }
                }
            } catch (error) {
                console.log("Błąd metody EWS:", error.message);
            }
            
            // Jeśli wszystkie metody zawiodły, pokazujemy częściowe potwierdzenie
            document.getElementById("partialConfirmation").style.display = "block";
        }
        
        // Funkcja tworząca żądanie SOAP dla EWS w celu wysłania wiadomości
        function getEwsSendMessageXml(emailDetails) {
            var recipients = '';
            emailDetails.toRecipients.forEach(function(recipient) {
                recipients += '<t:Mailbox><t:EmailAddress>' + recipient + '</t:EmailAddress></t:Mailbox>';
            });
            
            var xml = '<?xml version="1.0" encoding="utf-8"?>' +
                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
                'xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages" ' +
                'xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types" ' +
                'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
                '  <soap:Header>' +
                '    <t:RequestServerVersion Version="Exchange2013" />' +
                '  </soap:Header>' +
                '  <soap:Body>' +
                '    <m:CreateItem MessageDisposition="SendAndSaveCopy">' +
                '      <m:Items>' +
                '        <t:Message>' +
                '          <t:Subject>' + emailDetails.subject + '</t:Subject>' +
                '          <t:Body BodyType="HTML">' + emailDetails.htmlBody + '</t:Body>' +
                '          <t:ToRecipients>' + recipients + '</t:ToRecipients>' +
                '        </t:Message>' +
                '      </m:Items>' +
                '    </m:CreateItem>' +
                '  </soap:Body>' +
                '</soap:Envelope>';
                
            return xml;
        }
        
        // Funkcja alternatywna dla wysyłania wiadomości
        function fallbackSendMethod(emailDetails) {
            try {
                // Użyj displayNewMessageForm jako alternatywnej metody
                Office.context.mailbox.displayNewMessageForm(emailDetails);
                
                // Wyświetl informację, że użytkownik musi ręcznie zatwierdzić
                showNotification("Proszę kliknąć 'Wyślij' aby zakończyć zgłaszanie spamu");
                document.getElementById("manualConfirmation").style.display = "block";
            } catch (error) {
                document.getElementById("error").text
