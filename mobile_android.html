<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Zgłoś Spam | Ratels Security</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
    h1 { font-size: 1.5em; }
    .message { margin: 16px 0; padding: 12px; border-radius: 4px; }
    .success { background: #e6ffe6; color: #1a7f1a; }
    .error { background: #ffe6e6; color: #a11a1a; }
    .log { background: #f0f0f0; color: #333; font-size: 0.95em; margin-top: 10px; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    button { margin-top: 12px; padding: 8px 16px; font-size: 1em; border-radius: 4px; border: none; background: #0078d4; color: #fff; cursor: pointer; }
    button:active { background: #005fa3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Zgłoś spam</h1>
    <p>Kliknij przycisk, aby zgłosić podejrzaną wiadomość do zespołu bezpieczeństwa.</p>
    <button id="reportBtn">Zgłoś jako spam</button>
    <div id="resultMessage" class="message" style="display:none"></div>
    <div id="logBox" class="log" style="display:none"></div>
  </div>
  <script>
    function showMessage(text, type = 'success') {
      const div = document.getElementById("resultMessage");
      div.textContent = text;
      div.className = 'message ' + type;
      div.style.display = "block";
    }

    function log(text) {
      const logBox = document.getElementById("logBox");
      logBox.style.display = "block";
      logBox.textContent += text + "\n";
      logBox.scrollTop = logBox.scrollHeight;
      // Dodatkowo log do konsoli
      console.log(text);
    }

    Office.onReady(() => {
      document.getElementById("reportBtn").addEventListener("click", () => {
        showMessage("Wysyłanie zgłoszenia...", "success");
        document.getElementById("reportBtn").disabled = true;
        document.getElementById("logBox").textContent = ""; // wyczyść logi

        const item = Office.context.mailbox.item;
        if (!item) {
          showMessage("Nie można pobrać szczegółów wiadomości.", "error");
          log("Brak obiektu item w Office.context.mailbox");
          document.getElementById("reportBtn").disabled = false;
          return;
        }

        // Pobierz podstawowe dane
        const data = {
          subject: item.subject || "(brak tematu)",
          sender: item.from ? (item.from.emailAddress || item.from.displayName) : "(nieznany nadawca)",
          receivedTime: item.dateTimeCreated ? new Date(item.dateTimeCreated).toLocaleString() : "(nieznany czas)",
          messageId: item.internetMessageId || "(brak ID)"
        };

        log("Pobrane dane z maila:");
        log(JSON.stringify(data, null, 2));

        // Pobierz treść (asynchronicznie)
        item.body.getAsync(Office.CoercionType.Text, function(result) {
          let cleaned = "(brak treści)";
          if (result.status === Office.AsyncResultStatus.Succeeded && result.value) {
            cleaned = result.value;
            log("Pobrano treść wiadomości.");
          } else {
            log("Nie udało się pobrać treści wiadomości: " + result.status);
          }

          const payload = {
            ...data,
            body: cleaned
          };

          log("Payload do wysłania:");
          log(JSON.stringify(payload, null, 2));

          // Wyślij dane do backendu
          fetch('http://51.38.204.119:3000/report-spam', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          })
          .then(async res => {
            log("Odpowiedź HTTP status: " + res.status);
            let responseText = await res.text();
            log("Odpowiedź serwera: " + responseText);
            let result;
            try {
              result = JSON.parse(responseText);
            } catch (e) {
              showMessage("Błąd: nieprawidłowa odpowiedź serwera (status: " + res.status + "): " + responseText, "error");
              log("Błąd parsowania odpowiedzi JSON: " + e.message);
              document.getElementById("reportBtn").disabled = false;
              return;
            }
            if (res.ok && result.success) {
              showMessage("Zgłoszono!", "success");
            } else {
              showMessage("Błąd: " + (result.error || responseText), "error");
            }
            document.getElementById("reportBtn").disabled = false;
          })
          .catch(err => {
            showMessage("Błąd połączenia (np. CORS, sieć): " + err.message, "error");
            log("Błąd fetch: " + err.message);
            document.getElementById("reportBtn").disabled = false;
          });
        });
      });
    });
  </script>
</body>
</html>
