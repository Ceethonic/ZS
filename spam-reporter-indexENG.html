<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spam Reporter</title>
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #0078d4;
        }
        .report-button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }
        .report-button:hover {
            background: #106ebe;
        }
        .report-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success {
            background: #dff6dd;
            color: #107c10;
        }
        .error {
            background: #fde7e9;
            color: #d13438;
        }
        .warning {
            background: #fff4ce;
            color: #856404;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .report-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .report-section h3 {
            margin-top: 0;
            color: #0078d4;
        }
        .report-section pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .link-section {
            margin-top: 15px;
        }
        .link-section a {
            color: #0078d4;
            text-decoration: none;
        }
        .link-section a:hover {
            text-decoration: underline;
        }
        .safe-link {
            color: #107c10;
        }
        .suspicious-link {
            color: #d13438;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Spam Reporter</h2>
            <p>Report suspicious messages to our security team</p>
        </div>
        <button id="reportButton" class="report-button">Report as Spam</button>
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Preparing report...</p>
        </div>
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        Office.onReady(() => {
            document.getElementById('reportButton').addEventListener('click', reportSpam);
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function extractActiveLinks(text) {
            const linkRegex = /(https?:\/\/[^\s<>"]+|www\.[^\s<>"]+)/g;
            const links = text.match(linkRegex) || [];
            return [...new Set(links.map(link => 
                link.startsWith('www.') ? 'http://' + link : link
            ))];
        }

        function isSafeLink(link) {
            const safeDomains = [
                'ratels.pl',
                'microsoft.com',
                'office.com',
                'outlook.com',
                'hotmail.com',
                'live.com',
                'msn.com',
                'sharepoint.com',
                'onedrive.com',
                'teams.microsoft.com',
                'ratest.net.pl'
            ];
            return safeDomains.some(domain => link.includes(domain));
        }

        async function reportSpam() {
            const reportButton = document.getElementById('reportButton');
            const loading = document.getElementById('loading');
            const status = document.getElementById('status');

            try {
                // Get message ID first
                const item = await new Promise((resolve, reject) => {
                    Office.context.mailbox.item.getAllInternetHeadersAsync((result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve(Office.context.mailbox.item);
                        } else {
                            reject(new Error('Failed to get message headers'));
                        }
                    });
                });

                // Check if message was already reported
                const messageId = item.itemId;
                const reportedMessages = JSON.parse(localStorage.getItem('reportedMessages') || '[]');
                if (reportedMessages.includes(messageId)) {
                    status.className = 'status warning';
                    status.textContent = 'This message has already been reported as spam.';
                    status.style.display = 'block';
                    return;
                }

                // Show loading indicator
                loading.style.display = 'block';
                reportButton.disabled = true;

                // Get message details
                const data = {
                    subject: item.subject || "(no subject)",
                    sender: item.from ? item.from.emailAddress : "(unknown sender)",
                    receivedTime: item.dateTimeCreated ? new Date(item.dateTimeCreated).toLocaleString() : "(unknown time)",
                    messageId: item.itemId || "(no message ID)",
                    importance: item.importance || "(unknown importance)",
                    categories: item.categories || [],
                    conversationId: item.conversationId || "(no conversation ID)",
                    bodyPreview: item.bodyPreview || "(no preview)",
                    recipient: item.toRecipients ? item.toRecipients[0].emailAddress : 'unknown recipient'
                };

                // Get message body
                const body = await new Promise((resolve, reject) => {
                    Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve(result.value);
                        } else {
                            reject(new Error('Failed to get message body'));
                        }
                    });
                });

                // Extract links from body
                const links = extractActiveLinks(body);
                const safeLinks = links.filter(isSafeLink);
                const suspiciousLinks = links.filter(link => !isSafeLink(link));

                // Get attachments
                const attachments = await new Promise((resolve, reject) => {
                    Office.context.mailbox.item.attachments.getAsync((result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve(result.value);
                        } else {
                            reject(new Error('Failed to get attachments'));
                        }
                    });
                });

                // Prepare report body
                const reportBody = `
                    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="background: linear-gradient(135deg, #0078d4, #106ebe); color: white; padding: 20px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px;">
                            <h2 style="margin: 0;">Spam Report</h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">Suspicious message details</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="color: #0078d4; margin-top: 0;">Basic Information</h3>
                            <p><strong>Subject:</strong> ${data.subject}</p>
                            <p><strong>From:</strong> ${data.sender}</p>
                            <p><strong>To:</strong> ${data.recipient}</p>
                            <p><strong>Received:</strong> ${data.receivedTime}</p>
                            <p><strong>Message ID:</strong> ${data.messageId}</p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="color: #0078d4; margin-top: 0;">Message Metadata</h3>
                            <p><strong>Importance:</strong> ${data.importance}</p>
                            <p><strong>Categories:</strong> ${data.categories.join(', ') || 'None'}</p>
                            <p><strong>Conversation ID:</strong> ${data.conversationId}</p>
                        </div>

                        ${attachments.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: #0078d4; margin-top: 0;">Attachments</h3>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${attachments.map(att => `
                                        <li style="padding: 8px; background: white; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <span style="font-weight: bold;">${att.name}</span>
                                            ${att.size ? `<span style="color: #666; margin-left: 10px;">${formatFileSize(att.size)}</span>` : ''}
                                            ${att.contentType ? `<span style="color: #666; margin-left: 10px;">${att.contentType}</span>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${links.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: #0078d4; margin-top: 0;">Detected Links</h3>
                                ${safeLinks.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: #107c10; margin: 0 0 10px 0;">Safe Links</h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${safeLinks.map(link => `
                                                <li style="padding: 8px; background: white; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                                    <a href="${link}" target="_blank" style="color: #107c10; text-decoration: none;">${link}</a>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${suspiciousLinks.length > 0 ? `
                                    <div>
                                        <h4 style="color: #d13438; margin: 0 0 10px 0;">Suspicious Links</h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${suspiciousLinks.map(link => `
                                                <li style="padding: 8px; background: white; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                                    <a href="${link}" target="_blank" style="color: #d13438; text-decoration: none;">${link}</a>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <h3 style="color: #0078d4; margin-top: 0;">Message Content</h3>
                            <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef;">
                                <pre style="margin: 0; white-space: pre-wrap; font-family: 'Segoe UI', Arial, sans-serif;">${body}</pre>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                            <p>This report was generated automatically by Ratels Security Spam Reporter</p>
                        </div>
                    </div>
                `;

                // Create new message
                const message = {
                    toRecipients: ['tomaszciszewski01@gmail.com'],
                    subject: `Spam report from: ${data.recipient || 'unknown recipient'}`,
                    htmlBody: reportBody,
                    attachments: [
                        {
                            type: Office.MailboxEnums.AttachmentType.Item,
                            itemId: item.itemId,
                            name: "spam_message.eml"
                        }
                    ]
                };

                // Display new message form
                Office.context.mailbox.displayNewMessageForm(message);

                // Add message to reported list
                reportedMessages.push(messageId);
                localStorage.setItem('reportedMessages', JSON.stringify(reportedMessages));

                // Show success message
                status.className = 'status success';
                status.textContent = 'Report prepared successfully. Please review and send the message.';
                status.style.display = 'block';

                // Hide loading indicator
                loading.style.display = 'none';

                // Close the add-in pane after 3 seconds
                setTimeout(() => {
                    Office.context.ui.messageParent(JSON.stringify({ type: 'close' }));
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                status.className = 'status error';
                status.textContent = 'Error: ' + error.message;
                status.style.display = 'block';
                loading.style.display = 'none';
                reportButton.disabled = false;
            }
        }
    </script>
</body>
</html>
